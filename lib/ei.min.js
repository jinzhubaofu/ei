(function(a,b){'object'==typeof exports&&'undefined'!=typeof module?b(exports,require('react'),require('prop-types'),require('react-redux'),require('redux')):'function'==typeof define&&define.amd?define('ei',['exports','react','prop-types','react-redux','redux'],b):b(a.ei={},a.React,a.PropTypes,a.reactRedux,a.redux)})(this,function(a,b,c,d,e){'use strict';function f(g,h,i,a,b,c,d,e){if(!g){if(!h)throw new Error('Minified exception occurred; use the non-minified dev environment for the full error message and additional helpful warnings.');var f=[i,a,b,c,d,e],j=0,k='Invariant Violation: '+h.replace(/%s/g,function(){return f[j++]});throw new Error(k)}}function g(a){return{type:B,payload:a}}function h(a){return{type:C,payload:a}}function i(a){function d(a){var b={};for(var c in a)I.call(a,c)&&!(c in e.propTypes)&&(b[c]=a[c]);return b}var e=function(b){function c(){m(this,c);var d=q(this,b.call(this)),e=d.props.initialState,f=d.page=new a(e);return f.on('*',function(){for(var a=arguments.length,b=Array(a),c=0;c<a;c++)b[c]=arguments[c];var e=f.getCurrentEvent().split(/[\-_]/).map(function(a){return a.charAt(0).toUpperCase()+a.slice(1).toLowerCase()}).join(''),g=d.props['on'+e];'function'==typeof g&&g.apply(d,b)}),d.state={stage:null==e?'INITED':'LOADED',error:null},d}return o(c,b),c.prototype.componentDidMount=function(){var a=this.handleRequest,b=this.page,c=this.props,d=this.state.stage;'LOADED'===d||a(b,c.request)},c.prototype.componentWillReceiveProps=function(a){var b=this.props.request,c=a.request;b!==c&&this.handleRequest(this.page,c)},c.prototype.componentWillUnmount=function(){var a=this.page;a&&a.dispose(),this.page=null},c.prototype.handleRequest=function(a,b){var c=this,d=this[H]=D();this.setState({stage:'LOADING',error:null}),Promise.resolve(a.getInitialState(b)).then(function(b){a.init(b),d===c[H]&&c.setState({stage:'LOADED'})},function(a){d===c[H]&&c.setState({error:a,stage:'LOADED'})})},c.prototype.render=function(){var a=this.page,b=this.props,c=this.state,e=c.error,f=c.stage,g=b.renderLoadingMessage,h=b.renderErrorMessage;return e?h(e):'LOADED'===f?a.createElement(d(b)):g()},c}(b.PureComponent);return e.displayName='PageComponent',e.propTypes={initialState:c.object,request:c.object,renderLoadingMessage:c.func,renderErrorMessage:c.func},e.defaultProps={initialState:null,request:{},renderLoadingMessage:function(){return j.createElement('div',null,'loading...')},renderErrorMessage:function(a){return j.createElement('div',null,a.message)}},e}var j='default'in b?b['default']:b;c=c&&c.hasOwnProperty('default')?c['default']:c;var k='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&'function'==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?'symbol':typeof a},l=function(){function a(a){this.value=a}function b(b){function c(e,f){try{var g=b[e](f),h=g.value;h instanceof a?Promise.resolve(h.value).then(function(a){c('next',a)},function(a){c('throw',a)}):d(g.done?'return':'normal',g.value)}catch(a){d('throw',a)}}function d(a,b){'return'===a?e.resolve({value:b,done:!0}):'throw'===a?e.reject(b):e.resolve({value:b,done:!1});e=e.next,e?c(e.key,e.arg):f=null}var e,f;this._invoke=function(a,b){return new Promise(function(d,g){var h={key:a,arg:b,resolve:d,reject:g,next:null};f?f=f.next=h:(e=f=h,c(a,b))})},'function'!=typeof b.return&&(this.return=void 0)}return'function'==typeof Symbol&&Symbol.asyncIterator&&(b.prototype[Symbol.asyncIterator]=function(){return this}),b.prototype.next=function(a){return this._invoke('next',a)},b.prototype.throw=function(a){return this._invoke('throw',a)},b.prototype.return=function(a){return this._invoke('return',a)},{wrap:function(a){return function(){return new b(a.apply(this,arguments))}},await:function(b){return new a(b)}}}(),m=function(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')},n=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a},o=function(a,b){if('function'!=typeof b&&null!==b)throw new TypeError('Super expression must either be null or a function, not '+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)},p=function(a,b){var c={};for(var d in a)0<=b.indexOf(d)||Object.prototype.hasOwnProperty.call(a,d)&&(c[d]=a[d]);return c},q=function(a,b){if(!a)throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called');return b&&('object'==typeof b||'function'==typeof b)?b:a},r='__listeners__',s='__event__',t=function(){function a(){m(this,a)}return a.prototype.on=function(a,b){var c=this[r];c||(c=this[r]={});var d=c[a];return d||(d=c[a]=[]),d.push(b),this},a.prototype.off=function(a,b){var c=this[r];if(!c)return this;if(!a)return this.destroyEvents();var d=c[a];if(!d||!d.length)return this;if(!b)return d.length=0,c[a]=[],this;for(var e=d.length-1;0<=e;--e)if(d[e]===b)return d.splice(e,1),this;return this},a.prototype.once=function(a,b){function c(){d.off(a,c);for(var e=arguments.length,f=Array(e),g=0;g<e;g++)f[g]=arguments[g];return b.apply(d,f)}var d=this;return d.on(a,c),this},a.prototype.emit=function(a){var b=this[r];if(!b)return this;var c=[].concat(b[a]||[],b['*']||[]);if(!c.length)return this;this[s]=a;for(var d=arguments.length,e=Array(1<d?d-1:0),f=1;f<d;f++)e[f-1]=arguments[f];for(var g=0,h=c.length;g<h;++g)c[g].apply(this,e);return this[s]=null,this},a.prototype.getCurrentEvent=function(){return this[s]},a.prototype.destroyEvents=function(){var a=this[r];if(a){for(var b in a)a[b]&&(a[b].length=0,a[b]=null);this[r]=null}return this},a}(),u=new t,v=function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];m(this,a),this.routes=b}return a.prototype.route=function(a){for(var b,c=this.routes.length-1;0<=c;c--)if(b=this.routes[c],b.path===a.pathname)return b},a.prototype.addRoute=function(a){return this.routes.push(a),this},a}(),w=!1,x=!1;try{w='object'===('undefined'==typeof process?'undefined':k(process))&&'[object process]'===Object.prototype.toString.call(process),x=!w}catch(a){x=!0}var y=Object.prototype.hasOwnProperty,z=Object.assign||function(a){if(null==a)throw new Error('assign target cannot be null');for(var b=arguments.length,c=Array(1<b?b-1:0),d=1;d<b;d++)c[d-1]=arguments[d];for(var e,f=0,g=c.length;f<g;++f)if(e=c[f],'object'===('undefined'==typeof e?'undefined':k(e)))for(var h in e)y.call(e,h)&&(a[h]=e[h]);return a},A=function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};m(this,a),f(b,'App need options'),f(b.routes||b.router,'App need routes/router'),z(this,b),this.router=this.router||new v(this.routes)}return a.prototype.execute=function(a,b){f(w,'App.execute() must run on server'),u.emit('app-request');var c=this.route(a);return c?this.loadPage(c.page).then(function(d){var e=new d;return Promise.resolve(e.getInitialState(a)).then(function(a){return b?(u.emit('app-response-in-json'),{state:a,route:c}):(u.emit('app-response-in-html'),e.init(a),u.emit('app-page-bootstrap'),u.emit('app-page-entered'),{page:e,route:c})})})['catch'](function(a){throw u.emit('app-execute-error',a),a}):Promise.reject({status:404})},a.prototype.setBasePath=function(a){return this.basePath=a,this},a.prototype.loadPage=function(a){var b=this;if('function'==typeof a)return Promise.resolve(a);var c=this.pool;if(c&&c[a])return u.emit('app-page-loaded'),Promise.resolve(c[a]);var d=w?'resolveServerModule':'resolveClientModule';return this[d](a).then(function(a){return b.resolvePage(a)})},a.prototype.resolvePage=function(a){return'function'==typeof a?a:a['default']},a.prototype.resolveServerModule=function(a){var b=this;u.emit('app-load-page-on-server',a);var c=this.basePath;f(c,'ei need a basePath to resolve your page');return new Promise(function(d,f){try{var e=require(c+'/'+a),g=b.pool;g||(g=b.pool={}),g[a]=e,d(e)}catch(a){f(a)}})},a.prototype.resolveClientModule=function(a){return u.emit('app-load-page-on-client'),a?new Promise(function(b){window.require([a],function(a){b(a)})}):Promise.reject(new Error('need page module id'))},a.prototype.route=function(a){u.emit('app-route');var b=this.router.route(a);return b?u.emit('app-route-succeed'):u.emit('app-route-failed',a),b},a}();A.Component=function(a){var d=function(b){function c(){m(this,c);var d=q(this,b.call(this)),e=d.props,f=e.routes,g=e.router,h=e.app;return d.app=h||new a({routes:f,router:g}),d.state={},d}return o(c,b),c.prototype.getChildContext=function(){var a=this.app;return{route:function(b){return a.route(b)},loadPage:function(b){return a.loadPage(b)}}},c.prototype.render=function(){return this.props.children},c}(b.PureComponent);return d.propTypes={routes:c.arrayOf(c.shape({path:c.string.isRequired,page:c.oneOfType([c.string,c.func]).isRequired})),app:c.instanceOf(a),router:c.object},d.childContextTypes={route:c.func,loadPage:c.func},d}(A);var B='ei/INIT',C='ei/REPLACE',D=function(){return Math.random().toString(36).substr(2,12)},E='ASYNC_PAGE_LOAD_ATTR',F=function(a){function b(){var c,d,e;m(this,b);for(var f=arguments.length,g=Array(f),h=0;h<f;h++)g[h]=arguments[h];return e=(c=(d=q(this,a.call.apply(a,[this].concat(g))),d),d.state={pendding:!1,ready:!1,error:null},c),q(d,e)}return o(b,a),b.prototype.componentDidMount=function(){var a=this.props,b=a.initialState,c=a.request;this.renderPage(c,b)},b.prototype.componentWillReceiveProps=function(a){var b=this.props.request||{},c=b.pathname,d=b.search,e=a.request;b!==e&&(c!==e.pathname||d!==e.search)&&this.renderPage(e,null)},b.prototype.renderPage=function(a){var b=this,c=this.context.route(a);if(!c)return void this.setState({ready:!1,error:{status:404,message:'\u554A\u54E6\uFF0C\u8FD9\u4E2A\u9875\u9762\u8FF7\u5931\u5728\u4E86\u832B\u832B\u5B87\u5B99\u4E2D\u3002\u3002\u3002'},pendding:!1,Page:null});this.setState({pendding:!0,error:null,ready:!1});var d=this[E]=D();this.context.loadPage(c.page).then(function(a){d===b[E]&&b.setState({Page:a,error:null,pendding:!1,ready:!0})})['catch'](function(a){d===b[E]&&b.setState({error:a,ready:!1,pendding:!1,Page:null})})},b.prototype.onRedirect=function(a){var b=this.props.onRedirect;return b?void b(a):void this.renderPage(a.payload.location)},b.prototype.render=function(){var a=this.props,b=a.request,c=a.renderLoadingMessage,d=a.renderErrorMessage,e=p(a,['request','renderLoadingMessage','renderErrorMessage']),f=this.state,g=f.ready,h=f.pendding,i=f.Page,k=f.error,l='blank',m=null;if(null!=b)if(k)m=d(k),l='error';else if(h)m=c(),l='pendding';else if(g)try{m=j.createElement(i.Component,n({},e,{renderLoadingMessage:c,renderErrorMessage:d,onRedirect:this.onRedirect,request:b})),l='ready'}catch(a){m=d(a),l='error'}return j.createElement('div',{className:'ui-page state-'+l},m)},b}(b.PureComponent);F.displayName='Page',F.contextTypes={route:c.func,loadPage:c.func},F.propTypes={request:c.shape({pathname:c.string.isRequired,query:c.object,search:c.string}),initialState:c.any,renderLoadingMessage:c.func,renderErrorMessage:c.func},F.defaultProps={renderErrorMessage:function(a){return j.createElement('span',null,a.message)},renderLoadingMessage:function(){return j.createElement('span',null,'loading...')}};var G=function(a){return function(){return function(b){return function(c){if('function'!=typeof c){var d=c.event,e=c.type;a.emit(d||e,c)}return b(c)}}}},H='PAGE_GET_INITIAL_STATE_GUID_ATTR',I=Object.prototype.hasOwnProperty,J=function(a){function b(c){m(this,b);var d=q(this,a.call(this));return d.middlewares=[G],d.initialize(c),d}return o(b,a),b.prototype.initialize=function(a){var b=this;this.id=D();var c=this.reducer||this.constructor.reducer;'object'===('undefined'==typeof c?'undefined':k(c))&&(c=e.combineReducers(this.reducer));var d=e.compose;'production'!==process.env.NODE_ENV&&x&&window&&window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__&&(d=window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__({name:'ei-page@'+this.id})),this.context=e.createStore(function(a,b){return b.type===C?b.payload:c(a,b)},a,d(e.applyMiddleware.apply(void 0,this.middlewares.map(function(a){return a(b)}))))},b.prototype.init=function(a){return this.dispatch(g(a)),this},b.prototype.createElement=function(a){var b=this.context,c=this.view||this.constructor.view;return j.createElement(d.Provider,{store:b},j.createElement(c,a))},b.prototype.getState=function(){return this.context.getState()},b.prototype.setState=function(a){return this.context.dispatch(h(a)),this},b.prototype.dispatch=function(a){return u.emit('page-dispatch',a),this.emit('dispatch',a),this.context.dispatch(a),a},b.prototype.getInitialState=function(){return{}},b.prototype.dispose=function(){return u.emit('page-dispose'),this.emit('dispose'),this},b}(t);J.extend=function(a){f(a,'create Page need options'),f(a.reducer,'Pager must have a reducer'),f(a.view,'Pager must have a view');var b=function(a){function b(){return m(this,b),q(this,a.apply(this,arguments))}return o(b,a),b}(J);return z(b.prototype,a),b.Component=i(b),b},J.Component=F;var K=function(){function a(){m(this,a),this.boundCallbacks={},this.singletonCallbacks={},this.instantiatedSingletons={},this.registeredObjects={}}return a.prototype.make=function(a){if(this.registeredObjects[a])return this.registeredObjects[a];if(this.singletonCallbacks[a]){var b=this.instantiatedSingletons,c=b[a];return c||(c=b[a]=this.singletonCallbacks[a].apply(this,arguments)),c}var d=this.boundCallbacks[a];return d?d.apply(this,arguments):null},a.prototype.bind=function(a,b){return this.boundCallbacks[a]=b,this},a.prototype.singleton=function(a,b){return this.singletonCallbacks[a]=b,this},a.prototype.register=function(a,b){return this.registeredObjects[a]=b,this},a}(),L=new K,M=Object.freeze({register:function(a,b){return L.register(a,b),this},get:function(a){return L.make(a)}});a.App=A,a.Page=J,a.Container=K,a.events=u,a.resource=M,a.actionTypes={INIT:B,REPLACE:C},a.actions={init:g,replace:h},Object.defineProperty(a,'__esModule',{value:!0})});
//# sourceMappingURL=ei.min.js.map
